<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="content-language" content="en">
	<meta property="og:locale" content="en_US">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes">
	<meta name="description" content="YOUR DESC HERE">
	<meta property="og:image:width" content="IMAGE WIDTH HERE">
	<meta property="og:image:height" content="IMAGE HEIGHT HERE">
	<meta property="og:image:type" content="image/*">
	<meta property="og:type" content="website">
	<meta property="og:image" content="YOUR IMAGE HERE">
	<meta property="og:url" content="ABSOLUTE URL HERE">
	<meta property="og:description" content="YOUR DESC HERE">
	<meta property="og:title" content="YOUR TITLE HERE">
	<meta property="og:site_name" content="YOUR TITLE HERE">
	<meta name="twitter:title" content="YOUR TITLE HERE">
	<meta name="application-name" content="YOUR TITLE HERE">
	<meta name="application-url" content="ABSOLUTE URL HERE">
	<meta name="twitter:url" content="ABSOLUTE URL HERE">
	<meta name="web_author" content="addsoupbase">
	<meta name="twitter:creator" content="@addsoupbase">
	<meta name="twitter:site" content="@addsoupbase">
	<meta name="twitter:creator:id" content="1799269566834454528">
	<meta name="twitter:site:id" content="1799269566834454528">
	<meta name="creator" content="addsoupbase">
	<meta name="designer" content="addsoupbase">
	<meta name="twitter:image" content="YOUR IMAGE HERE">
	<meta name="twitter:image:width" content="IMAGE WIDTH HERE">
	<meta name="twitter:image:height" content="IMAGE HEIGHT HERE">
	<meta name="msapplication-navbutton-color" content="YOUR COLOR HERE">
	<meta name="msapplication-TileColor" content="YOUR COLOR HERE">
	<meta name="msapplication-square150x150logo" content="./apple-touch-icon-152x152.png">
	<meta name="msapplication-square310x310logo" content="./apple-touch-icon-180x180.png">
	<meta name="msapplication-square70x70logo" content="./apple-touch-icon-72x72.png">
	<meta name="msapplication-wide310x150logo" content="./apple-touch-icon-180x180.png">
	<meta name="msapplication-TileImage" content="./apple-touch-icon-180x180.png">
	<meta name="msapplication-starturl" content="ABSOLUTE URL HERE">
	<meta name="origin" content="ABSOLUTE URL HERE">
	<meta name="msapplication-tooltip" content="YOUR TITLE HERE">
	<meta name="prism:alternateTitle" content="YOUR TITLE HERE">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="thumbnail" content="YOUR IMAGE HERE">
	<meta property="profile:username" content="addsoupbase">
	<!--summary_large_image,summary,app,or player -->
	<link rel="icon" type="image/x-icon" href="favicon.ico">
	<link rel="shortcut icon" href="favicon.ico">
	<meta name="robots" content="index">
	<meta name="theme-color" content="YOUR COLOR HERE">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="author" content="addsoupbase">
	<link rel="canonical" href="ABSOLUTE URL HERE">
	<script
		type="application/ld+json">{"@context":"https://schema.org","@type": "WebSite","name":"addsoupbase","url":"ABSOLUTE URL HERE","description":"YOUR DESC HERE","author":{"@type": "Person","name":"addsoupbase","sameAs":["https://twitter.com/addsoupbase"]},"mainEntityOfPage":{"@type":"WebPage","@id":"ABSOLUTE URL HERE"},"image":{"@type":"ImageObject","url":"YOUR IMAGE HERE","width":IMAGE WIDTH HERE,"height":IMAGE HEIGHT HERE}}</script>
	<link rel="apple-touch-icon" sizes="57x57" href="./apple-touch-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="./apple-touch-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="./apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="./apple-touch-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="./apple-touch-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="./apple-touch-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="./apple-touch-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="./apple-touch-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon-180x180.png">
	<meta name="mobile-web-app-capable" content="no">
	<meta name="apple-mobile-web-app-capable" content="no">
	<!--^ yes if the site has stuff like back buttons-->
	<meta name="apple-mobile-web-app-title" content="YOUR TITLE HERE">
	<link rel="apple-touch-startup-image" href="favicon.ico">
	<script src="../css.js" blocking="render"></script>
	<script src="../css_bad.js" nomodule></script>
	<!-- <link rel="stylesheet" href="../styles.css"> -->
	<style>
		@font-face {
			font-family: 'Choco';
			font-display: swap;
			src: local('Choco cooky'), local('Chococooky'), url('../media/Chococooky.woff2') format('woff2'),
				/* Super Modern Browsers */
				url('../media/Chococooky.woff') format('woff');
			/* Pretty Modern Browsers */
			font-weight: normal;
			font-style: normal;
		}

		body,
		html,
		:root {
			padding: initial;
			margin: initial;
			font-family: 'Choco';
		}

		div {
			/* margin: 20px */
		}

		* {
			font-size: xx-large;
		}

		#images:empty::before {
			content: "No images"
		}

		#audio:empty::before {
			content: "No audio"
		}

		#images {
			/* display: grid; */
			place-items: center;
		}

		.media {
			display: inline-block
		}

		#images img {
			/* margin: 10px */
		}

		#hi {
			display: flex;
			place-content: space-between;


		}

		#hi>* {
			margin: 5px
		}
	</style>
	<title>YOUR TITLE HERE</title>
	<meta name="color-scheme" content="dark">
	<!--https://wiki.whatwg.org/wiki/MetaExtensions-->
	<!--[if IE]><script>alert('Please update your browser')</script><![endif]-->
	<noscript>
		<!-- <a href='REDIRECT HERE'>Click if you are not redirected</a><style>body{display:none !important}</style><meta content='0;url=REDIRECT HERE' http-equiv='refresh'> -->
	</noscript>
</head>

<body>
	<main class="centerx">
		<div>
			<label>
				Date:
				<select id="selectDate">
					<!-- <script>
						document.write(`<option></option>`)
					</script> -->
				</select>
			</label>
			<output for="selectDate">
				<div>
					<input type="color" value="#000000" id="color" style="width:50%;height:40px">
					<textarea id="about" placeholder="Summary"></textarea>
					<div id="hi">
						<div class="media">
							<h2>Images</h2>
							<div id="images"></div>
						</div>
						<div class="media">
							<h2>Audio</h2>
							<div id="audio"></div>
						</div>
					</div>
					<button id="addMedia">Add Media</button>
					<button id="addExternalMedia">Add External Media</button>
					<button id="addVideo">Add Video</button>
					<div style="margin:5px;border:1px solid white;max-height:300px">
						<h2>Videos</h2>
						<div id="videos"></div>
					</div>
				</div>
			</output>
			<iframe width="500" height="300" id="fr"></iframe>
		</div>
	</main>
	<script type="module">
		import '../h.js'
		// import{daysOfTheWeek}from '../str.js'
		let dayName = /mon|tue|wed|thu|fri|sat|sun/i
		function repDate(day) {
			switch (day.toLowerCase()) {
				case 'mon': return 'Monday'
				case 'tue': return 'Tuesday'
				case 'wed': return 'Wednesday'
				case 'thu': return 'Thursday'
				case 'fri': return 'Friday'
				case 'sat': return 'Saturday'
				case 'sun': return 'Sunday'
			}
		}
		let monthName = /jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec/i
		function repMonth(month) {
			switch (month.toLowerCase()) {
				case 'jan': return 'January'
				case 'feb': return 'February'
				case 'mar': return 'March'
				case 'apr': return 'April'
				case 'may': return 'May'
				case 'jun': return 'June'
				case 'jul': return 'July'
				case 'aug': return 'August'
				case 'sep': return 'September'
				case 'oct': return 'October'
				case 'nov': return 'November'
				case 'dec': return 'December'
			}
		}
		const h = window[Symbol.for('[[HModule]]')]
		import $, { escapeHTML } from '../yay.js'
		let dates = await (await fetch('../dates.json', { cache: 'no-cache' })).json()
		let { selectDate, fr, about, color, addMedia, images, audio, addVideo, videos, addExternalMedia } = $.id
		let all = dates.map(o => new Date(o))
		addExternalMedia.on({
			async click() {
				let url = prompt("Enter image url:")
				if (!url) return
				imgMeta(url)
			}
		})
		about.on({
			change() {
				for (let n of currentDOM.querySelectorAll('[data-cat="about"]')) {
					n.setAttribute('content', this.value)
				}
				updateEntry(currentDOM, today)
			}
		})
		async function updateEntry(doc, date) {
			let url = toNormal(date)
			await fetch(`http://localhost:3003/?date=${encodeURIComponent(url)}`, { method: "POST", body: `<!DOCTYPE html>${doc.documentElement.outerHTML}` })
		}
		addVideo.on({
			async click() {
				let src = prompt('Enter video url. Dropbox files should have &dl=1 at the end')
				if (!src) return
				let n = $`<video src="${src}"></video>`
				n.canPlay || await n.until('loadeddata', 'error')
				let url = new URL(src)
				let txt =
					`<meta property="og:video" content="${src}" />
<meta property="og:video:type" content="video/${url.pathname.split('.').at(-1)}" />
<meta property="og:video:width" content="${n.videoWidth}" />
<meta property="og:video:height" content="${n.videoHeight}" />`
				insertHTML(txt)
				if (!currentDOM.querySelector(`link[rel="preconnect"][href="${url.origin}"]`)) insertHTML(`<link rel="preconnect" href="${url.origin}">`)
				videos.push($`<a href="${src}" target="_blank">${url.pathname.split('/').at(-1)}</a>`)
				updateEntry(currentDOM, today)
			}
		})
		let parse = DOMParser.prototype.parseFromString.bind(new DOMParser)
		let folder = null
		if (!~dates.indexOf(new Date().toDateString())) {
			if (!sessionStorage.a && confirm("Would you like to create a new entry for today?")) {
				await fetch(`http://localhost:3003/newentry`, { mode: "cors" })
				location.reload()
				// sessionStorage.a = 'yeh'
				// let text = await(await fetch('../template.html')).text()
				// await fetch(`http://localhost:3001`, {mode:'cors', method:'POST'})
			}
		}
		function addPrefetch(){
			
		}
		async function fetchHTML(src, date) {
			let a = await fetch(src, { cache: 'no-cache' })
			let txt = await a.text()
			currentDOM = parse(txt, 'text/html')
			let index = all.map(String).indexOf(date.toString())
				;[].forEach.call(currentDOM.querySelectorAll('link[rel="prefetch"][href$="/index.html"]'), o => o.remove())
			let yesterday = all[index + 1]
			let tomorrow = all[index - 1]
			if (yesterday) {
				currentDOM.head.insertAdjacentHTML('afterbegin', `<link rel="prefetch" href="../${toNormal(yesterday)}/index.html">`)
			}
			if (tomorrow) {
				currentDOM.head.insertAdjacentHTML('afterbegin', `<link rel="prefetch" href="../${toNormal(tomorrow)}/index.html">`)
			}
			let oldDiaryScript = currentDOM.head.querySelector('script[src="../../diary.js"]')
			if (oldDiaryScript) {
				oldDiaryScript.remove()
			}
			currentDOM.querySelector('script[src="../../diary.js"]') || currentDOM.body.insertAdjacentHTML('beforeend', `<script type="module" src="../../diary.js" async${'>'}<${'/'}script>`)
			for (let a of currentDOM.querySelectorAll('script[type="module"]')) {
				if (a.textContent.trim().startsWith(`import '../../csshelper.js'`)) {
					if (currentDOM.querySelector('script[src="../../css.js"]')) a.remove()
					else {
						a.outerHTML =
							`${'<'}script blocking="render" src="../../css.js"${'>'}${'<'}${'/'}script${'>'}
${'<'}script nomodule src="../../css_bad.js"${'>'}${'<'}${'/'}script${'>'}`
					}
				}
			}

			return currentDOM
		}
		let currentDOM = null
		function toLocal(url) {
			return url.replace('https://addsoupbase.github.io/', 'http://localhost:3000/')
		}
		function displayAudio(src, title) {
			audio.push($`<audio controls src="${toLocal(src)}" title="${escapeHTML(title)}"></audio>`)

		}
		function audioMeta(file) {
			let d = toNormal(today)
			let src = `https://addsoupbase.github.io/entries/${d}/${encodeURIComponent(file.name)}`
			let txt =
				`<meta property="og:audio" content="${src}">
	<meta property="og:audio:type" content="${file.type}">`
			insertHTML(txt)
			displayAudio(src, file.name)
			updateEntry(currentDOM, today)
		}
		async function imgMeta(file) {
			let d = toNormal(today)
			let url = typeof file === 'string' ? file : await URL.createObjectURL(file)
			let img = new Image
			img.src = url
			img.loading && await h.until(img, 'load', 'error')
			let src = typeof file === 'string' ? file : `https://addsoupbase.github.io/entries/${d}/${encodeURIComponent(file.name)}`
			let txt =
				`
	<meta property="og:image" content="${src}">
	<meta property="og:image:type" content="${file.type || `image/${img.src.split('.').at(-1)}`}">
	<meta property="og:image:alt" content="${escapeHTML(prompt(" Enter alt text for '" + (file.name || img.src) + "' :"))}">
	<meta property="og:image:width" content="${img.naturalWidth}">
	<meta property="og:image:height" content="${img.naturalHeight}">
	`
			if (confirm('Make this the twitter card?')) {
				txt += `<meta name="twitter:image" content="${src}"><meta name="twitter:card" content="${confirm('Large image?') ? 'summary_large_image' : 'summary'}">`
			}
			insertHTML(txt)
			displayImage(src)
			updateEntry(currentDOM, today)
		}
		function insertHTML(html) {
			[].at.call(currentDOM.getElementsByTagName('meta'), -1).insertAdjacentHTML('afterend', html)
		}
		async function handleImage(file) {
			// let stream = await folder.createWritable()
			// await stream.write(file)
			// await stream.close()

		}
		addMedia.on({
			async click() {
				// if (folder === null) {
				// folder = await showDirectoryPicker({mode:'readwrite'})
				// }
				let files = await h.requestFile('mp3 ogg wav webp png jpg jpeg gif avif pdf'.split(' ').map(o => `.${o}`).join(','),
					true)
				for (let file of files) {
					switch (file.type.split('/')[0]) {
						case 'image': imgMeta(file)
							break
						// case 'video': handleVideo(file)
						// break
						case 'audio': audioMeta(file)
							break
					}
				}
			}
		})
		function toNormal(date) {
			let out = `${date.getMonth() + 1}_${String(date.getDate())}_${date.getFullYear()}`
			return out
		}
		for (let date of all.reverse()) {
			selectDate.push($`<option value="${date}">${date.toISOString().slice(0, 10)}</option>`)
		}
		let today
		color.on({
			change() {
				for (let n of currentDOM.querySelectorAll(`meta[data-cat="color"]`)) {
					n.setAttribute('content', this.value)
				}
				updateEntry(currentDOM, today)
			}
		})
		async function setDay(date) {
			today = date
			date = toNormal(date)
			let src = `../entries/${date}/index.html`
			let doc = await fetchHTML(src, today)
			fr.src = src
			about.value = doc.querySelector('[data-cat="about"]')?.getAttribute('content') || ''
			color.value = doc.querySelector('meta[name="theme-color"]')?.getAttribute('content') || '#000000'
			images.empty()
			audio.empty()
			for (let n of Array.from(doc.querySelectorAll('meta[property="og:image"]'), o => o.getAttribute('content'))) {
				displayImage(n)
			}
			for (let n of Array.from(doc.querySelectorAll('meta[property="og:audio"]'), o => o.getAttribute('content'))) {
				displayAudio(o)
			}
		}
		selectDate.debounce({
			change() {
				let date = new Date(this.value)
				setDay(date)
			}
		}, 300)
		function displayImage(src) {
			images.push($`<img width="50" height="50" src="${toLocal(src)}">`)
		}
		setDay(all[0])
		console.log(currentDOM)
		Object.defineProperty(window, 'c', {
			get() { return currentDOM }
		})
		h.on(document, {
			visibilitychange() {
				document.hidden || location.reload()
			}
		})
		/*for(let n of all) {
		let a = toNormal(n)
		let html = await fetchHTML(`../entries/${a}/index.html`,n)
		updateEntry(html, new Date(n))
	}
	console.log('done')*/
	</script>
</body>

</html>